var re=Object.defineProperty;var le=(f,e,t)=>e in f?re(f,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):f[e]=t;var r=(f,e,t)=>le(f,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const s of i.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&a(s)}).observe(document,{childList:!0,subtree:!0});function t(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(n){if(n.ep)return;n.ep=!0;const i=t(n);fetch(n.href,i)}})();class ce{constructor(e){r(this,"gl");r(this,"canvas");this.canvas=e;const t=e.getContext("webgl2",{alpha:!1,antialias:!0,depth:!0});if(!t)throw new Error("WebGL2 not supported");this.gl=t,this.validateExtensions(),this.logInfo()}validateExtensions(){const e=["EXT_color_buffer_float"];for(const t of e)if(!this.gl.getExtension(t))throw new Error(`Required WebGL extension not available: ${t}`)}logInfo(){const e=this.gl;console.log("✓ WebGL2 Context Created"),console.log("  Vendor:",e.getParameter(e.VENDOR)),console.log("  Renderer:",e.getParameter(e.RENDERER)),console.log("  Version:",e.getParameter(e.VERSION)),console.log("  GLSL Version:",e.getParameter(e.SHADING_LANGUAGE_VERSION))}resize(e,t){this.canvas.width=e,this.canvas.height=t,this.gl.viewport(0,0,e,t)}clear(e,t,a){this.gl.clearColor(e,t,a,1),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT)}}const he=`#version 300 es
precision highp float;

in vec3 aPosition;
uniform mat4 uModelViewProjection;

void main() {
  gl_Position = uModelViewProjection * vec4(aPosition, 1.0);
}
`,de=`#version 300 es
precision highp float;

uniform vec3 uColor;
out vec4 fragColor;

void main() {
  fragColor = vec4(uColor, 1.0);
}
`,ue=`#version 300 es
precision highp float;
precision highp sampler3D;

in vec3 aPosition;
uniform mat4 uModelViewProjection;
uniform float uPointSize;
uniform sampler3D uVolume;
uniform vec3 uVolumeRes; // Volume resolution (x, y, z) for density calculation

out vec4 vColor;

void main() {
  gl_Position = uModelViewProjection * vec4(aPosition, 1.0);
  
  // Sample volume data
  vec3 texCoord = (aPosition + 1.0) * 0.5;
  vec4 data = texture(uVolume, texCoord);
  
  // R = Magnitude, G = Phase, B = Custom1, A = Custom2
  float magnitude = data.r;
  float phase = data.g;
  
  // Calculate maximum point size based on grid density
  // Points should not be larger than the grid cell spacing
  float minRes = min(min(uVolumeRes.x, uVolumeRes.y), uVolumeRes.z);
  float maxPointSize = (2.0 / minRes) * 100.0; // Grid cell size in screen space (approximate)
  
  // Size based on magnitude with logarithmic scaling
  // Logarithmic scale makes low magnitudes more visible while preserving dynamics
  float size = uPointSize;
  if (magnitude > 0.001) {
      // log(1 + x*k) gives gentle compression, making dim points visible
      size = uPointSize * (1.0 + log(1.0 + magnitude * 20.0) * 1.5);
  }
  
  // Clamp to max size based on density
  size = min(size, maxPointSize);
  
  gl_PointSize = size;
  
  // Pass color to fragment shader
  // R channel = Magnitude (Red)
  // G channel = Phase (Green)
  // Mix them for visualization
  vColor = vec4(magnitude, phase, 0.2, magnitude); 
}
`,pe=`#version 300 es
precision highp float;

in vec4 vColor;
uniform float uAlpha;
out vec4 fragColor;

void main() {
  // Make points circular (not square)
  vec2 coord = gl_PointCoord - vec2(0.5);
  if (length(coord) > 0.5) discard;
  
  // Use color from vertex shader, modulate alpha
  // If magnitude is low, make it very transparent
  float alpha = uAlpha;
  if (vColor.r > 0.01) {
      alpha = uAlpha + vColor.r * 0.5; // More opacity for higher magnitude
  }
  
  fragColor = vec4(vColor.rgb, alpha);
}
`,me=`#version 300 es
precision highp float;
precision highp sampler3D;

in vec3 aPosition;
uniform mat4 uModelViewProjection;
uniform mat4 uModelMatrix; // To transform position to world space for sampling
uniform sampler3D uVolume;

out vec4 vColor;

void main() {
  gl_Position = uModelViewProjection * vec4(aPosition, 1.0);
  
  // Transform position to world space (which matches volume space [-1, 1])
  // Note: The plane is transformed by uModelMatrix (rotation/translation)
  // We need to sample the volume at this transformed position.
  // However, uModelViewProjection includes View and Projection.
  // We need a separate uModelMatrix to get world coordinates.
  // BUT, wait. The plane vertices are local to the plane.
  // The plane moves through the volume.
  // So we need to apply the plane's transformation to get volume coordinates.
  
  vec4 worldPos = uModelMatrix * vec4(aPosition, 1.0);
  vec3 texCoord = (worldPos.xyz + 1.0) * 0.5;
  
  // Sample volume
  // Use trilinear filtering (hardware or manual if needed, but hardware linear is usually fine)
  vec4 data = texture(uVolume, texCoord);
  
  // Visualize data
  // R = Magnitude -> Red/Intensity
  // G = Phase -> Green/Variation
  float mag = data.r;
  float phase = data.g;
  
  // Base color (teal) mixed with data
  vec3 baseColor = vec3(0.0, 1.0, 0.5);
  vec3 activeColor = vec3(1.0, 0.2, 0.2); // Reddish for high magnitude
  
  // Mix based on magnitude
  vec3 finalColor = mix(baseColor, activeColor, mag);
  
  // Add phase influence to green channel
  finalColor.g += phase * 0.3;
  
  vColor = vec4(finalColor, 1.0);
}
`,ge=`#version 300 es
precision highp float;

in vec4 vColor;
uniform float uAlpha;
out vec4 fragColor;

void main() {
  fragColor = vec4(vColor.rgb, uAlpha);
}
`;function B(){const f=new Float32Array(16);return f[0]=f[5]=f[10]=f[15]=1,f}function fe(f,e,t,a){const n=1/Math.tan(f/2),i=1/(t-a),s=new Float32Array(16);return s[0]=n/e,s[5]=n,s[10]=(a+t)*i,s[11]=-1,s[14]=2*a*t*i,s}function ve(f,e,t){const a=f[0]-e[0],n=f[1]-e[1],i=f[2]-e[2];let s=1/Math.sqrt(a*a+n*n+i*i);const o=a*s,l=n*s,h=i*s,c=t[1]*h-t[2]*l,d=t[2]*o-t[0]*h,m=t[0]*l-t[1]*o;s=1/Math.sqrt(c*c+d*d+m*m);const u=c*s,p=d*s,g=m*s,y=l*g-h*p,v=h*u-o*g,C=o*p-l*u,x=new Float32Array(16);return x[0]=u,x[1]=y,x[2]=o,x[4]=p,x[5]=v,x[6]=l,x[8]=g,x[9]=C,x[10]=h,x[12]=-(u*f[0]+p*f[1]+g*f[2]),x[13]=-(y*f[0]+v*f[1]+C*f[2]),x[14]=-(o*f[0]+l*f[1]+h*f[2]),x[15]=1,x}function _(f){const e=Math.cos(f),t=Math.sin(f),a=B();return a[5]=e,a[6]=t,a[9]=-t,a[10]=e,a}function Y(f){const e=Math.cos(f),t=Math.sin(f),a=B();return a[0]=e,a[2]=-t,a[8]=t,a[10]=e,a}function X(f){const e=Math.cos(f),t=Math.sin(f),a=B();return a[0]=e,a[1]=t,a[4]=-t,a[5]=e,a}function G(f,e,t){const a=B();return a[12]=f,a[13]=e,a[14]=t,a}function k(f,e){const t=new Float32Array(16);for(let a=0;a<4;a++)for(let n=0;n<4;n++)t[n*4+a]=f[0*4+a]*e[n*4+0]+f[1*4+a]*e[n*4+1]+f[2*4+a]*e[n*4+2]+f[3*4+a]*e[n*4+3];return t}function ye(f,e){const t=f[0],a=f[1],n=f[2],i=e[3]*t+e[7]*a+e[11]*n+e[15],s=i!==0?1/i:1;return[(e[0]*t+e[4]*a+e[8]*n+e[12])*s,(e[1]*t+e[5]*a+e[9]*n+e[13])*s,(e[2]*t+e[6]*a+e[10]*n+e[14])*s]}class Ce{constructor(e,t){r(this,"ctx");r(this,"texture",null);r(this,"resolution");r(this,"data",null);r(this,"gameOfLifeState",null);r(this,"gameOfLifeBuffer",null);r(this,"plasmaTime",0);this.ctx=e,this.resolution=t,this.initialize()}initialize(){const e=this.ctx.gl;if(this.texture&&e.deleteTexture(this.texture),this.texture=e.createTexture(),!this.texture)throw new Error("Failed to create 3D texture");e.bindTexture(e.TEXTURE_3D,this.texture);const{x:t,y:a,z:n}=this.resolution,i=t*a*n;(!this.data||this.data.length!==i*4)&&(this.data=new Float32Array(i*4),this.data.fill(0)),e.texImage3D(e.TEXTURE_3D,0,e.RGBA32F,t,a,n,0,e.RGBA,e.FLOAT,this.data),e.texParameteri(e.TEXTURE_3D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_3D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_3D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_3D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_3D,e.TEXTURE_WRAP_R,e.CLAMP_TO_EDGE),e.bindTexture(e.TEXTURE_3D,null);const s=i*4*4/(1024*1024);console.log(`✓ Spectral Volume: ${t}×${a}×${n} = ${i} voxels (${s.toFixed(2)} MB)`)}setData(e){const t=this.ctx.gl,{x:a,y:n,z:i}=this.resolution;if(e.length!==a*n*i*4)throw new Error("Data length does not match volume resolution");this.data=e,t.bindTexture(t.TEXTURE_3D,this.texture),t.texSubImage3D(t.TEXTURE_3D,0,0,0,0,a,n,i,t.RGBA,t.FLOAT,e),t.bindTexture(t.TEXTURE_3D,null)}generate3DJulia(){const{x:e,y:t,z:a}=this.resolution,n=e*t*a,i=new Float32Array(n*4),s=12,o=8,l=2.2;let h=0;for(let c=0;c<a;c++)for(let d=0;d<t;d++)for(let m=0;m<e;m++){const u=m/e*2-1,p=d/t*2-1,g=c/a*2-1,y=(u+1)*l-1,v=p*l,C=g*l,x=-.2,P=.6,T=.2;let S=y,L=v,b=C,R=0,w=0;for(;w<s&&(R=Math.sqrt(S*S+L*L+b*b),!(R>2));w++){let E=Math.acos(b/R),F=Math.atan2(L,S);const V=Math.pow(R,o);E=E*o,F=F*o,S=V*Math.sin(E)*Math.cos(F),L=V*Math.sin(E)*Math.sin(F),b=V*Math.cos(E),S+=x,L+=P,b+=T}let A=0;if(w<s&&w>2){const E=w+1-Math.log(Math.log(R))/Math.log(2);A=Math.max(0,1-E/s),A=Math.pow(A,2.5),A<.25?A=0:A=(A-.25)/.75}const M=1+(1-(u+1)*.5)*.3;A*=M,A=Math.min(1,A);const N=(w/s+u*.1)%1,z=(p+1)*.5,D=(g+1)*.5;i[h++]=A,i[h++]=N,i[h++]=z,i[h++]=D}this.setData(i)}generateMandelbulb(){const{x:e,y:t,z:a}=this.resolution,n=e*t*a,i=new Float32Array(n*4),s=12,o=8;let l=0;for(let h=0;h<a;h++)for(let c=0;c<t;c++)for(let d=0;d<e;d++){const m=d/e*2-1,u=c/t*2-1,p=h/a*2-1,g=(m+1)*1.2-1,y=u*1.2,v=p*1.2;let C=0,x=0,P=0,T=1,S=0,L=0;for(;L<s&&(S=Math.sqrt(C*C+x*x+P*P),!(S>2));L++){let N=Math.acos(P/S),z=Math.atan2(x,C);T=Math.pow(S,o-1)*o*T+1;const D=Math.pow(S,o);N=N*o,z=z*o,C=D*Math.sin(N)*Math.cos(z)+g,x=D*Math.sin(N)*Math.sin(z)+y,P=D*Math.cos(N)+v}let b=0;if(L<s){const N=.5*Math.log(S)*S/T;b=Math.max(0,1-N*8)}b=Math.pow(b,1.8);const R=1+(1-(m+1)*.5)*.4;b*=R;const w=L/s,A=(u+1)*.5,M=(p+1)*.5;i[l++]=b,i[l++]=w,i[l++]=A,i[l++]=M}this.setData(i)}generateMengerSponge(){const{x:e,y:t,z:a}=this.resolution,n=e*t*a,i=new Float32Array(n*4);let s=0;for(let o=0;o<a;o++)for(let l=0;l<t;l++)for(let h=0;h<e;h++){const c=h/e*2-1,d=l/t*2-1,m=o/a*2-1;let u=(c+1)*1.5,p=(d+1)*1.5,g=(m+1)*1.5,y=!0,v=1;for(let b=0;b<4;b++){if(u=Math.abs(u),p=Math.abs(p),g=Math.abs(g),u>v/3&&u<2*v/3&&p>v/3&&p<2*v/3){y=!1;break}if(p>v/3&&p<2*v/3&&g>v/3&&g<2*v/3){y=!1;break}if(g>v/3&&g<2*v/3&&u>v/3&&u<2*v/3){y=!1;break}u=u*3%v,p=p*3%v,g=g*3%v,v/=3}let C=y?.7:0;const x=Math.sqrt(u*u+p*p+g*g);C*=.8+.2*Math.sin(x*20);const P=1+(1-(c+1)*.5)*.3;C*=P;const T=(u+p+g)%1,S=(d+1)*.5,L=(m+1)*.5;i[s++]=C,i[s++]=T,i[s++]=S,i[s++]=L}this.setData(i)}generateSinePlasma(e=0){const{x:t,y:a,z:n}=this.resolution,i=t*a*n,s=new Float32Array(i*4);let o=0;for(let l=0;l<n;l++)for(let h=0;h<a;h++)for(let c=0;c<t;c++){const d=c/t*2-1,m=h/a*2-1,u=l/n*2-1;let p=0;p+=Math.sin(d*3+e),p+=Math.sin(m*2.5+e*.8),p+=Math.sin(u*2+e*1.2),p+=Math.sin((d+m+u)*2+e*.5);const g=Math.sqrt(d*d+m*m+u*u);p+=Math.sin(g*6-e*1.5);const y=Math.atan2(m,d);p+=Math.sin(y*3+u*4+e);let v=(p+6)/12;v=(Math.sin(v*15)+1)*.5,v=Math.pow(v,2.5);const C=1+(1-(d+1)*.5)*.5;v*=C,v=Math.max(0,Math.min(.9,v));const x=(v+e*.2)%1,P=(Math.sin(d*Math.PI+e)+1)*.5,T=(Math.cos(m*Math.PI+e)+1)*.5;s[o++]=v,s[o++]=x,s[o++]=P,s[o++]=T}this.setData(s)}stepSinePlasma(){this.plasmaTime+=.02,this.generateSinePlasma(this.plasmaTime)}clearData(){const{x:e,y:t,z:a}=this.resolution,n=e*t*a,i=new Float32Array(n*4);i.fill(0),this.setData(i)}sample(e,t,a){if(!this.data)return new Float32Array([0,0,0,0]);const{x:n,y:i,z:s}=this.resolution,o=Math.max(0,Math.min(1,e)),l=Math.max(0,Math.min(1,t)),h=Math.max(0,Math.min(1,a)),c=o*(n-1),d=l*(i-1),m=h*(s-1),u=Math.floor(c),p=Math.floor(d),g=Math.floor(m),y=c-u,v=d-p,C=m-g,x=Math.min(u+1,n-1),P=Math.min(p+1,i-1),T=Math.min(g+1,s-1),S=(E,F,V)=>(V*i*n+F*n+E)*4,L=S(u,p,g),b=S(x,p,g),R=S(u,P,g),w=S(x,P,g),A=S(u,p,T),M=S(x,p,T),N=S(u,P,T),z=S(x,P,T),D=new Float32Array(4);for(let E=0;E<4;E++){const F=this.data[L+E],V=this.data[b+E],U=this.data[R+E],q=this.data[w+E],K=this.data[A+E],J=this.data[M+E],Q=this.data[N+E],ee=this.data[z+E],te=F*(1-y)+V*y,ae=U*(1-y)+q*y,ne=K*(1-y)+J*y,ie=Q*(1-y)+ee*y,se=te*(1-v)+ae*v,oe=ne*(1-v)+ie*v;D[E]=se*(1-C)+oe*C}return D}updateResolution(e){this.resolution=e,this.data=null,this.initialize()}getResolution(){return{...this.resolution}}getTexture(){return this.texture}destroy(){this.texture&&(this.ctx.gl.deleteTexture(this.texture),this.texture=null),this.data=null,this.gameOfLifeState=null,this.gameOfLifeBuffer=null}initGameOfLife(){const{x:e,y:t,z:a}=this.resolution,n=e*t*a;this.gameOfLifeState=new Uint8Array(n),this.gameOfLifeBuffer=new Uint8Array(n);for(let i=0;i<n;i++)this.gameOfLifeState[i]=Math.random()<.3?1:0;this.gameOfLifeToSpectral()}stepGameOfLife(){if(!this.gameOfLifeState||!this.gameOfLifeBuffer)return;const{x:e,y:t,z:a}=this.resolution,n=(s,o,l)=>{const h=(s%e+e)%e,c=(o%t+t)%t;return(l%a+a)%a*t*e+c*e+h};for(let s=0;s<a;s++)for(let o=0;o<t;o++)for(let l=0;l<e;l++){const h=n(l,o,s);let c=0;for(let m=-1;m<=1;m++)for(let u=-1;u<=1;u++)for(let p=-1;p<=1;p++){if(p===0&&u===0&&m===0)continue;const g=n(l+p,o+u,s+m);c+=this.gameOfLifeState[g]}this.gameOfLifeState[h]===1?this.gameOfLifeBuffer[h]=c===4||c===5?1:0:this.gameOfLifeBuffer[h]=c===5?1:0}const i=this.gameOfLifeState;this.gameOfLifeState=this.gameOfLifeBuffer,this.gameOfLifeBuffer=i,this.gameOfLifeToSpectral()}gameOfLifeToSpectral(){if(!this.gameOfLifeState)return;const{x:e,y:t,z:a}=this.resolution,n=e*t*a,i=new Float32Array(n*4);let s=0;for(let o=0;o<a;o++)for(let l=0;l<t;l++)for(let h=0;h<e;h++){const c=o*t*e+l*e+h,d=this.gameOfLifeState[c],m=h/e*2-1,u=l/t*2-1,p=o/a*2-1;let g=d?.8:0;if(d){const x=1+(1-(m+1)*.5)*.4;g*=x}const y=(h/e+l/t+o/a)/3,v=(u+1)*.5,C=(p+1)*.5;i[s++]=g,i[s++]=y,i[s++]=v,i[s++]=C}this.setData(i)}}var O=(f=>(f.FLAT="PLANE",f.SINCOS="PLOT 1",f.WAVE="PLOT 2",f.RIPPLE="PLOT 3",f))(O||{});const xe=16,Se=512,H=64,we=1,Me=16,j=2,Ee=16,be=1024,Z=128;var I=(f=>(f.SPECTRAL="spectral",f.WAVETABLE="wavetable",f))(I||{});class W{static calculateHeight(e,t,a){switch(a){case O.FLAT:return 0;case O.SINCOS:return .3*(Math.sin(e*Math.PI*2)*Math.cos(t*Math.PI*2));case O.WAVE:return .2*Math.sin((e+t)*Math.PI*3);case O.RIPPLE:const n=Math.sqrt(e*e+t*t);return .25*Math.sin(n*Math.PI*4)/(1+n*2);default:return 0}}static generatePlane(e,t=32){const a=[],n=[];for(let i=0;i<t;i++)for(let s=0;s<t;s++){const o=s/(t-1)*2-1,l=i/(t-1)*2-1,h=this.calculateHeight(o,l,e);a.push(o,h,l)}for(let i=0;i<t-1;i++)for(let s=0;s<t-1;s++){const o=i*t+s,l=o+1,h=(i+1)*t+s,c=h+1;s<t-1&&(n.push(o,l),n.push(h,c)),i<t-1&&(n.push(o,h),n.push(l,c))}return{positions:new Float32Array(a),indices:new Uint16Array(n)}}static generateReadingLine(e,t,a=0){const n=[],i=Math.max(-1,Math.min(1,a));for(let s=0;s<t;s++){const o=s/(t-1)*2-1,l=this.calculateHeight(o,i,e);n.push(o,l,i)}return new Float32Array(n)}}class Pe{constructor(e,t){r(this,"ctx");r(this,"wireframeProgram");r(this,"wireframeVAO");r(this,"wireframeUMVP");r(this,"wireframeUColor");r(this,"pointProgram");r(this,"pointVAO",null);r(this,"pointCount",0);r(this,"pointUMVP");r(this,"pointUVolume");r(this,"pointUAlpha");r(this,"pointUSize");r(this,"pointUVolumeRes");r(this,"planeProgram");r(this,"planeVAO",null);r(this,"planeIndexCount",0);r(this,"planeUMVP");r(this,"planeUModel");r(this,"planeUVolume");r(this,"planeUAlpha");r(this,"lineVAO",null);r(this,"lineUMVP");r(this,"lineUColor");r(this,"lineVertexCount",0);r(this,"spectralVolume");r(this,"pathState",{position:{x:0,y:0,z:0},rotation:{x:0,y:0,z:0},scanPosition:0,planeType:O.FLAT});r(this,"rotationX",.3);r(this,"rotationY",.4);r(this,"isDragging",!1);r(this,"lastMouseX",0);r(this,"lastMouseY",0);r(this,"activeMouseButton",-1);this.ctx=e,this.spectralVolume=new Ce(e,t),this.wireframeProgram=this.createProgram(he,de);const a=e.gl.getUniformLocation(this.wireframeProgram,"uModelViewProjection"),n=e.gl.getUniformLocation(this.wireframeProgram,"uColor");if(!a||!n)throw new Error("Failed to get wireframe uniform locations");this.wireframeUMVP=a,this.wireframeUColor=n,this.wireframeVAO=this.createWireframeCube(),this.pointProgram=this.createProgram(ue,pe);const i=e.gl.getUniformLocation(this.pointProgram,"uModelViewProjection"),s=e.gl.getUniformLocation(this.pointProgram,"uVolume"),o=e.gl.getUniformLocation(this.pointProgram,"uAlpha"),l=e.gl.getUniformLocation(this.pointProgram,"uPointSize"),h=e.gl.getUniformLocation(this.pointProgram,"uVolumeRes");if(!i||!o||!l)throw new Error("Failed to get point uniform locations");this.pointUMVP=i,this.pointUVolume=s,this.pointUAlpha=o,this.pointUSize=l,this.pointUVolumeRes=h,this.planeProgram=this.createProgram(me,ge);const c=e.gl.getUniformLocation(this.planeProgram,"uModelViewProjection"),d=e.gl.getUniformLocation(this.planeProgram,"uModelMatrix"),m=e.gl.getUniformLocation(this.planeProgram,"uVolume"),u=e.gl.getUniformLocation(this.planeProgram,"uAlpha");if(!c||!u)throw new Error("Failed to get plane uniform locations");this.planeUMVP=c,this.planeUModel=d,this.planeUVolume=m,this.planeUAlpha=u,this.lineUMVP=a,this.lineUColor=n,this.updatePointCloud(t),this.updateReadingPathGeometry(),console.log("✓ Renderer initialized")}createProgram(e,t){const a=this.ctx.gl,n=a.createShader(a.VERTEX_SHADER);if(!n)throw new Error("Failed to create vertex shader");if(a.shaderSource(n,e),a.compileShader(n),!a.getShaderParameter(n,a.COMPILE_STATUS)){const o=a.getShaderInfoLog(n);throw new Error(`Vertex shader compile error: ${o}`)}const i=a.createShader(a.FRAGMENT_SHADER);if(!i)throw new Error("Failed to create fragment shader");if(a.shaderSource(i,t),a.compileShader(i),!a.getShaderParameter(i,a.COMPILE_STATUS)){const o=a.getShaderInfoLog(i);throw new Error(`Fragment shader compile error: ${o}`)}const s=a.createProgram();if(!s)throw new Error("Failed to create program");if(a.attachShader(s,n),a.attachShader(s,i),a.linkProgram(s),!a.getProgramParameter(s,a.LINK_STATUS)){const o=a.getProgramInfoLog(s);throw new Error(`Program link error: ${o}`)}return s}createWireframeCube(){const e=this.ctx.gl,t=new Float32Array([-1,-1,-1,1,-1,-1,1,1,-1,-1,1,-1,-1,-1,1,1,-1,1,1,1,1,-1,1,1]),a=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),n=e.createVertexArray();if(!n)throw new Error("Failed to create VAO");e.bindVertexArray(n);const i=e.createBuffer();if(!i)throw new Error("Failed to create vertex buffer");e.bindBuffer(e.ARRAY_BUFFER,i),e.bufferData(e.ARRAY_BUFFER,t,e.STATIC_DRAW);const s=e.getAttribLocation(this.wireframeProgram,"aPosition");e.enableVertexAttribArray(s),e.vertexAttribPointer(s,3,e.FLOAT,!1,0,0);const o=e.createBuffer();if(!o)throw new Error("Failed to create index buffer");return e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,o),e.bufferData(e.ELEMENT_ARRAY_BUFFER,a,e.STATIC_DRAW),e.bindVertexArray(null),n}generatePointCloud(e){const{x:t,y:a,z:n}=e,i=t*a*n,s=new Float32Array(i*3);let o=0;for(let l=0;l<n;l++)for(let h=0;h<a;h++)for(let c=0;c<t;c++)s[o++]=c/(t-1)*2-1,s[o++]=h/(a-1)*2-1,s[o++]=l/(n-1)*2-1;return s}updatePointCloud(e){const t=this.ctx.gl;this.pointVAO&&t.deleteVertexArray(this.pointVAO);const a=this.generatePointCloud(e);this.pointCount=a.length/3;const n=t.createVertexArray();if(!n)throw new Error("Failed to create point VAO");t.bindVertexArray(n);const i=t.createBuffer();if(!i)throw new Error("Failed to create point buffer");t.bindBuffer(t.ARRAY_BUFFER,i),t.bufferData(t.ARRAY_BUFFER,a,t.STATIC_DRAW);const s=t.getAttribLocation(this.pointProgram,"aPosition");t.enableVertexAttribArray(s),t.vertexAttribPointer(s,3,t.FLOAT,!1,0,0),t.bindVertexArray(null),this.pointVAO=n,console.log(`✓ Point cloud: ${this.pointCount} points`)}updateReadingPathGeometry(){const e=this.ctx.gl;this.planeVAO&&e.deleteVertexArray(this.planeVAO);const{positions:t,indices:a}=W.generatePlane(this.pathState.planeType);this.planeIndexCount=a.length;const n=e.createVertexArray();if(!n)throw new Error("Failed to create plane VAO");e.bindVertexArray(n);const i=e.createBuffer();e.bindBuffer(e.ARRAY_BUFFER,i),e.bufferData(e.ARRAY_BUFFER,t,e.STATIC_DRAW);const s=e.getAttribLocation(this.planeProgram,"aPosition");e.enableVertexAttribArray(s),e.vertexAttribPointer(s,3,e.FLOAT,!1,0,0);const o=e.createBuffer();e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,o),e.bufferData(e.ELEMENT_ARRAY_BUFFER,a,e.STATIC_DRAW),e.bindVertexArray(null),this.planeVAO=n;const l=this.spectralVolume.getResolution();this.updateReadingLineGeometry(l.x)}updateReadingLineGeometry(e){const t=this.ctx.gl;this.lineVAO&&t.deleteVertexArray(this.lineVAO);const a=W.generateReadingLine(this.pathState.planeType,e,this.pathState.scanPosition);this.lineVertexCount=a.length/3;const n=t.createVertexArray();if(!n)throw new Error("Failed to create line VAO");t.bindVertexArray(n);const i=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,i),t.bufferData(t.ARRAY_BUFFER,a,t.DYNAMIC_DRAW);const s=t.getAttribLocation(this.wireframeProgram,"aPosition");t.enableVertexAttribArray(s),t.vertexAttribPointer(s,3,t.FLOAT,!1,0,0),t.bindVertexArray(null),this.lineVAO=n}render(e=.016){this.update(e);const t=this.ctx.gl;this.ctx.clear(.08,.08,.12),t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA);const a=t.canvas.width/t.canvas.height,n=fe(Math.PI/4,a,.1,100),i=ve([0,0,6.5],[0,0,0],[0,1,0]),s=_(this.rotationX),o=Y(this.rotationY),l=k(o,s),h=k(i,l),c=k(n,h);if(this.pointVAO){t.useProgram(this.pointProgram),t.uniformMatrix4fv(this.pointUMVP,!1,c),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_3D,this.spectralVolume.getTexture()),t.uniform1i(this.pointUVolume,0),t.uniform1f(this.pointUAlpha,.15),t.uniform1f(this.pointUSize,3);const x=this.spectralVolume.getResolution();t.uniform3f(this.pointUVolumeRes,x.x,x.y,x.z),t.bindVertexArray(this.pointVAO),t.drawArrays(t.POINTS,0,this.pointCount),t.bindVertexArray(null)}const d=_(this.pathState.rotation.x),m=Y(this.pathState.rotation.y),u=X(this.pathState.rotation.z),p=G(this.pathState.position.x,this.pathState.position.y,this.pathState.position.z);let g=k(m,d);g=k(u,g),g=k(p,g);const y=k(l,g),v=k(i,y),C=k(n,v);this.planeVAO&&(t.useProgram(this.planeProgram),t.uniformMatrix4fv(this.planeUMVP,!1,C),t.uniformMatrix4fv(this.planeUModel,!1,y),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_3D,this.spectralVolume.getTexture()),t.uniform1i(this.planeUVolume,0),t.uniform1f(this.planeUAlpha,.3),t.bindVertexArray(this.planeVAO),t.drawElements(t.LINES,this.planeIndexCount,t.UNSIGNED_SHORT,0),t.bindVertexArray(null)),this.lineVAO&&(t.useProgram(this.wireframeProgram),t.uniformMatrix4fv(this.lineUMVP,!1,C),t.uniform3f(this.lineUColor,.2,1,.2),t.bindVertexArray(this.lineVAO),t.drawArrays(t.LINE_STRIP,0,this.lineVertexCount),t.bindVertexArray(null)),t.useProgram(this.wireframeProgram),t.uniformMatrix4fv(this.wireframeUMVP,!1,c),t.uniform3f(this.wireframeUColor,.3,.6,1),t.bindVertexArray(this.wireframeVAO),t.drawElements(t.LINES,24,t.UNSIGNED_SHORT,0),t.bindVertexArray(null),t.disable(t.BLEND)}resize(e,t){this.ctx.resize(e,t)}updateVolumeResolution(e){this.spectralVolume.updateResolution(e),this.updatePointCloud(e),this.updateReadingPathGeometry(),this.updateReadingLineGeometry(e.x)}getSpectralVolume(){return this.spectralVolume}updateReadingPath(e){const t=e.planeType!==this.pathState.planeType,a=e.scanPosition!==this.pathState.scanPosition;if(this.pathState={...e,rotation:{x:this.pathState.rotation.x,y:e.rotation.y,z:this.pathState.rotation.z}},t)this.updateReadingPathGeometry();else if(a){const n=this.spectralVolume.getResolution();this.updateReadingLineGeometry(n.x)}}updateSpectralData(e){switch(e){case"3d-julia":this.spectralVolume.generate3DJulia();break;case"mandelbulb":this.spectralVolume.generateMandelbulb();break;case"menger-sponge":this.spectralVolume.generateMengerSponge();break;default:this.spectralVolume.clearData();break}}getReadingLineSpectralData(){const e=this.spectralVolume.getResolution(),t=W.generateReadingLine(this.pathState.planeType,e.x,this.pathState.scanPosition),a=_(this.pathState.rotation.x),n=Y(this.pathState.rotation.y),i=X(this.pathState.rotation.z),s=G(this.pathState.position.x,this.pathState.position.y,this.pathState.position.z);let o=k(n,a);o=k(i,o),o=k(s,o);const l=t.length/3,h=new Float32Array(l*4);for(let c=0;c<l;c++){const d=t[c*3],m=t[c*3+1],u=t[c*3+2],p=ye([d,m,u],o),g=(p[0]+1)*.5,y=(p[1]+1)*.5,v=(p[2]+1)*.5,C=this.spectralVolume.sample(g,y,v);h[c*4]=C[0],h[c*4+1]=C[1],h[c*4+2]=C[2],h[c*4+3]=C[3]}return h}onMouseDown(e,t,a){this.isDragging=!0,this.lastMouseX=e,this.lastMouseY=t,this.activeMouseButton=a}onMouseMove(e,t){if(!this.isDragging)return;const a=e-this.lastMouseX,n=t-this.lastMouseY;this.lastMouseX=e,this.lastMouseY=t;const i=.01;this.activeMouseButton===2?(this.rotationY+=a*i,this.rotationX+=n*i):this.activeMouseButton===0&&(this.pathState.rotation.z-=a*i,this.pathState.rotation.x-=n*i,this.pathState.rotation.x=Math.max(-Math.PI/3,Math.min(Math.PI/3,this.pathState.rotation.x)),this.pathState.rotation.z=Math.max(-Math.PI/3,Math.min(Math.PI/3,this.pathState.rotation.z)))}onMouseUp(){this.isDragging=!1,this.activeMouseButton=-1}update(e){if(!this.isDragging){const t=5*e;this.pathState.rotation.x+=(0-this.pathState.rotation.x)*t,this.pathState.rotation.z+=(0-this.pathState.rotation.z)*t,Math.abs(this.pathState.rotation.x)<.001&&(this.pathState.rotation.x=0),Math.abs(this.pathState.rotation.z)<.001&&(this.pathState.rotation.z=0)}}destroy(){this.spectralVolume.destroy()}}class Ae{constructor(e){r(this,"container");r(this,"currentSectionContainer",null);r(this,"pathYSlider");r(this,"planeTypeSelect");r(this,"scanPositionSlider");r(this,"synthModeSelect");r(this,"frequencySlider");r(this,"frequencyContainer",null);r(this,"carrierContainer",null);r(this,"feedbackContainer",null);r(this,"midiSelect");r(this,"densityXSlider");r(this,"densityYSlider");r(this,"densityZSlider");r(this,"spectralDataSelect");r(this,"wavUploadInput");r(this,"dynamicParamSlider",null);r(this,"dynamicParamContainer",null);r(this,"onPathChange",null);r(this,"onVolumeResolutionChange");r(this,"onSpectralDataChange");r(this,"onWavUpload");r(this,"onDynamicParamChange");r(this,"onSynthModeChange",null);r(this,"onFrequencyChange",null);r(this,"onCarrierChange",null);r(this,"onFeedbackChange",null);r(this,"onMidiInputChange",null);r(this,"onOctaveChange",null);r(this,"onLFOParamChange",null);r(this,"onModulationRoutingChange",null);const t=document.getElementById(e);if(!t)throw new Error(`Container not found: ${e}`);this.container=t,this.createSection("Wave/Spectral Volume"),this.spectralDataSelect=this.createSelect("spectral-data-type","Data Set",["blank","3d-julia","mandelbulb","menger-sponge","sine-plasma","game-of-life"]),this.createResetButton(),this.createDynamicParameterSlider(),this.wavUploadInput=this.createFileInput("wav-upload","Upload WAV (Multi-select)",".wav,.mp3,.ogg",!0),this.createProgressIndicator(),this.createSection("Reading Path");const a=this.createModulatableSlider("path-y","Position Y (Morph)",-1,1,0,.01,"pathY");this.pathYSlider=a.slider,this.planeTypeSelect=this.createSelect("plane-type","Plane Type",[O.FLAT,O.SINCOS,O.WAVE,O.RIPPLE]);const n=this.createModulatableSlider("scan-pos","Scan Phase",-1,1,0,.01,"scanPhase");this.scanPositionSlider=n.slider,this.createSection("LFOs"),this.createLFOUnit(0),this.createLFOUnit(1),this.createSection("Audio Synthesis"),this.synthModeSelect=this.createSelect("synth-mode","Mode",[I.WAVETABLE,I.SPECTRAL]),this.frequencySlider=this.createFrequencySlider(),this.createCarrierSelect(),this.createFeedbackSlider(),this.midiSelect=this.createMidiSelect(),this.createOctaveSelect(),this.createSection("Visualization"),this.densityXSlider=this.createSlider("density-x","Freq Bins (X)",xe,Se,H,1),this.densityYSlider=this.createSlider("density-y","Morph Layers (Y)",we,Me,j,1),this.densityZSlider=this.createSlider("density-z","Time Res (Z)",Ee,be,Z,1),this.wireUpEvents()}createSection(e){const t=document.createElement("div");t.className="control-card";const a=document.createElement("div");a.className="control-section-title",a.textContent=e,t.appendChild(a),this.container.appendChild(t),this.currentSectionContainer=t}appendControl(e){(this.currentSectionContainer||this.container).appendChild(e)}createSlider(e,t,a,n,i,s){const o=document.createElement("div");o.className="control-group";const l=document.createElement("label");l.htmlFor=e,l.textContent=t;const h=document.createElement("span");h.className="value-display",h.textContent=s>=1?String(Math.round(i)):i.toFixed(2),h.id=`${e}-value`;const c=document.createElement("input");c.type="range",c.id=e,c.min=String(a),c.max=String(n),c.value=String(i),c.step=String(s),c.className="slider",c.addEventListener("input",()=>{const m=parseFloat(c.value);h.textContent=s>=1?String(Math.round(m)):m.toFixed(2)});const d=document.createElement("div");return d.className="label-row",d.appendChild(l),d.appendChild(h),o.appendChild(d),o.appendChild(c),this.appendControl(o),c}createSelect(e,t,a){const n=document.createElement("div");n.className="control-group";const i=document.createElement("label");i.htmlFor=e,i.textContent=t;const s=document.createElement("select");s.id=e,s.className="select";for(const l of a){const h=document.createElement("option");h.value=l,h.textContent=l,s.appendChild(h)}const o=document.createElement("div");return o.className="label-row",o.appendChild(i),n.appendChild(o),n.appendChild(s),this.appendControl(n),s}createModulatableSlider(e,t,a,n,i,s,o){const l=document.createElement("div");l.className="control-group";const h=document.createElement("label");h.htmlFor=e,h.textContent=t;const c=document.createElement("select");c.className="source-select",c.style.marginLeft="auto",c.style.fontSize="0.7rem",c.style.padding="2px",["None","LFO 1","LFO 2"].forEach(g=>{const y=document.createElement("option");y.value=g.toLowerCase().replace(" ",""),y.textContent=g,g==="None"&&(y.selected=!0),c.appendChild(y)}),c.addEventListener("change",()=>{this.onModulationRoutingChange&&this.onModulationRoutingChange(o,c.value),m.disabled=c.value!=="none",l.style.opacity=c.value!=="none"?"0.8":"1.0"});const d=document.createElement("span");d.className="value-display",d.textContent=s>=1?String(Math.round(i)):i.toFixed(2),d.id=`${e}-value`;const m=document.createElement("input");m.type="range",m.id=e,m.min=String(a),m.max=String(n),m.value=String(i),m.step=String(s),m.className="slider",m.addEventListener("input",()=>{const g=parseFloat(m.value);d.textContent=s>=1?String(Math.round(g)):g.toFixed(2)});const u=document.createElement("div");u.className="label-row",u.appendChild(h),u.appendChild(c);const p=document.createElement("div");return p.className="label-row",p.style.justifyContent="flex-end",p.appendChild(d),l.appendChild(u),l.appendChild(p),l.appendChild(m),this.appendControl(l),{slider:m,select:c}}createLFOUnit(e){const t=document.createElement("div");t.className="lfo-unit",t.style.marginBottom="10px",t.style.padding="5px",t.style.borderLeft="2px solid #333";const a=document.createElement("div");a.className="label-row",a.innerHTML=`<label>LFO ${e+1}</label>`,t.appendChild(a);const n=document.createElement("select");n.className="select",["Sine","Square","Saw","Triangle"].forEach(d=>{const m=document.createElement("option");m.value=d.toLowerCase(),m.textContent=d,n.appendChild(m)}),n.addEventListener("change",()=>{this.onLFOParamChange&&this.onLFOParamChange(e,"waveform",n.value)}),t.appendChild(n);const i=document.createElement("div");i.className="label-row",i.innerHTML='<label>Freq</label><span class="value-display">1.0 Hz</span>';const s=i.querySelector("span"),o=document.createElement("input");o.type="range",o.min="0",o.max="2000",o.step="0.1",o.value="1.0",o.className="slider",o.addEventListener("input",()=>{s.textContent=`${o.value} Hz`,this.onLFOParamChange&&this.onLFOParamChange(e,"frequency",parseFloat(o.value))}),t.appendChild(i),t.appendChild(o);const l=document.createElement("div");l.className="label-row",l.innerHTML='<label>Amp</label><span class="value-display">0.5</span>';const h=l.querySelector("span"),c=document.createElement("input");c.type="range",c.min="0",c.max="1",c.step="0.01",c.value="0.5",c.className="slider",c.addEventListener("input",()=>{h.textContent=c.value,this.onLFOParamChange&&this.onLFOParamChange(e,"amplitude",parseFloat(c.value))}),t.appendChild(l),t.appendChild(c),this.appendControl(t)}createFrequencySlider(){const e=document.createElement("div");e.id="frequency-container",e.className="control-group";const t=document.createElement("label");t.htmlFor="frequency",t.textContent="Frequency";const a=document.createElement("span");a.className="value-display",a.id="frequency-value",a.textContent="220 Hz (A3)";const n=document.createElement("input");n.type="range",n.id="frequency",n.min="20",n.max="2000",n.value="220",n.step="1",n.className="slider",n.addEventListener("input",()=>{const s=parseFloat(n.value),o=this.freqToNoteName(s);a.textContent=`${Math.round(s)} Hz (${o})`,this.onFrequencyChange&&this.onFrequencyChange(s)});const i=document.createElement("div");return i.className="label-row",i.appendChild(t),i.appendChild(a),e.appendChild(i),e.appendChild(n),this.appendControl(e),this.frequencySlider=n,n}createCarrierSelect(){const e=document.createElement("div");e.id="carrier-container",e.className="control-group";const t=document.createElement("label");t.htmlFor="carrier",t.textContent="Carrier";const a=document.createElement("select");a.id="carrier",a.className="select";const n=[{value:"0",label:"Sine"},{value:"1",label:"Saw"},{value:"2",label:"Square"},{value:"3",label:"Triangle"}];for(const s of n){const o=document.createElement("option");o.value=s.value,o.textContent=s.label,a.appendChild(o)}a.addEventListener("change",()=>{this.onCarrierChange&&this.onCarrierChange(parseInt(a.value))});const i=document.createElement("div");return i.className="label-row",i.appendChild(t),e.appendChild(i),e.appendChild(a),this.appendControl(e),a}createFeedbackSlider(){const e=document.createElement("div");e.id="feedback-container",e.className="control-group";const t=document.createElement("label");t.htmlFor="feedback",t.textContent="Feedback";const a=document.createElement("span");a.className="value-display",a.id="feedback-value",a.textContent="0%";const n=document.createElement("input");n.type="range",n.id="feedback",n.min="0",n.max="0.99",n.value="0",n.step="0.01",n.className="slider",n.addEventListener("input",()=>{const s=parseFloat(n.value);a.textContent=Math.round(s*100)+"%",this.onFeedbackChange&&this.onFeedbackChange(s)});const i=document.createElement("div");return i.className="label-row",i.appendChild(t),i.appendChild(a),e.appendChild(i),e.appendChild(n),this.appendControl(e),n}createMidiSelect(){const e=document.createElement("div");e.className="control-group";const t=document.createElement("label");t.htmlFor="midi-input",t.textContent="MIDI Input";const a=document.createElement("select");a.id="midi-input",a.className="select";const n=document.createElement("option");n.value="",n.textContent="No Devices Found",a.appendChild(n),a.addEventListener("change",()=>{this.onMidiInputChange&&this.onMidiInputChange(a.value)});const i=document.createElement("div");return i.className="label-row",i.appendChild(t),e.appendChild(i),e.appendChild(a),this.appendControl(e),a}createOctaveSelect(){const e=this.createSelect("octave-select","Keyboard Octave",["0","1","2","3","4","5","6","7"]);return e.value="3",e.addEventListener("change",()=>{this.onOctaveChange&&this.onOctaveChange(parseInt(e.value,10))}),e}freqToNoteName(e){const t=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],a=12*Math.log2(e/440)+69,n=Math.round(a),i=Math.floor(n/12)-1,s=n%12;return`${t[s]}${i}`}createFileInput(e,t,a,n=!1){const i=document.createElement("div");i.className="control-group";const s=document.createElement("label");s.htmlFor=e,s.textContent=t;const o=document.createElement("input");o.type="file",o.id=e,o.accept=a,o.multiple=n,o.className="file-input";const l=document.createElement("div");return l.className="label-row",l.appendChild(s),i.appendChild(l),i.appendChild(o),this.appendControl(i),o}createResetButton(){const e=document.createElement("div");e.className="control-group";const t=document.createElement("button");t.id="reset-dataset-btn",t.textContent="↻ Reset Dataset",t.className="reset-button",t.addEventListener("click",()=>{if(this.onSpectralDataChange){const a=this.spectralDataSelect.value;this.onSpectralDataChange(a)}}),e.appendChild(t),this.appendControl(e)}createDynamicParameterSlider(){const e=document.createElement("div");e.id="dynamic-param-container",e.className="control-group",e.style.display="none";const t=document.createElement("label");t.htmlFor="dynamic-param",t.id="dynamic-param-label",t.textContent="Parameter";const a=document.createElement("span");a.className="value-display",a.id="dynamic-param-value",a.textContent="500";const n=document.createElement("input");n.type="range",n.id="dynamic-param",n.min="0",n.max="1000",n.value="500",n.step="10",n.className="slider",n.addEventListener("input",()=>{const s=parseFloat(n.value);a.textContent=Math.round(s).toString(),this.onDynamicParamChange&&this.onDynamicParamChange(s)});const i=document.createElement("div");i.className="label-row",i.appendChild(t),i.appendChild(a),e.appendChild(i),e.appendChild(n),this.appendControl(e),this.dynamicParamSlider=n,this.dynamicParamContainer=e}createProgressIndicator(){const e=document.createElement("div");e.id="wav-progress-container",e.className="progress-container",e.style.display="none";const t=document.createElement("div");t.className="spinner";const a=document.createElement("div");a.className="progress-bar";const n=document.createElement("div");n.id="wav-progress-fill",n.className="progress-fill";const i=document.createElement("span");i.id="wav-progress-text",i.className="progress-text",i.textContent="0%",a.appendChild(n),e.appendChild(t),e.appendChild(a),e.appendChild(i),this.appendControl(e)}wireUpEvents(){const e=()=>{this.onPathChange&&this.onPathChange(this.getState())},t=()=>{this.onVolumeResolutionChange&&this.onVolumeResolutionChange({x:Math.round(parseFloat(this.densityXSlider.value)),y:Math.round(parseFloat(this.densityYSlider.value)),z:Math.round(parseFloat(this.densityZSlider.value))})},a=()=>{this.onSpectralDataChange&&this.onSpectralDataChange(this.spectralDataSelect.value)};this.spectralDataSelect.addEventListener("change",a),this.wavUploadInput.addEventListener("change",()=>{const n=this.wavUploadInput.files;n&&n.length>0&&this.onWavUpload&&this.onWavUpload(n)}),this.pathYSlider.addEventListener("input",e),this.planeTypeSelect.addEventListener("change",e),this.scanPositionSlider.addEventListener("input",e),this.synthModeSelect.addEventListener("change",()=>{const n=this.synthModeSelect.value,i=n===I.WAVETABLE;this.frequencyContainer&&(this.frequencyContainer.style.display=i?"block":"none"),this.carrierContainer&&(this.carrierContainer.style.display=i?"block":"none"),this.feedbackContainer&&(this.feedbackContainer.style.display=i?"block":"none"),this.onSynthModeChange&&this.onSynthModeChange(n)}),this.densityXSlider.addEventListener("change",t),this.densityYSlider.addEventListener("change",t),this.densityZSlider.addEventListener("change",t)}setPathChangeCallback(e){this.onPathChange=e}setSynthModeChangeCallback(e){this.onSynthModeChange=e}setFrequencyChangeCallback(e){this.onFrequencyChange=e}setFrequency(e){this.frequencySlider&&(this.frequencySlider.value=String(e));const t=document.getElementById("frequency-value");if(t){const a=this.freqToNoteName(e);t.textContent=`${Math.round(e)} Hz (${a})`}}setCarrierChangeCallback(e){this.onCarrierChange=e}setFeedbackChangeCallback(e){this.onFeedbackChange=e}setMidiInputChangeCallback(e){this.onMidiInputChange=e}setOctaveChangeCallback(e){this.onOctaveChange=e}updateMidiInputs(e){const t=this.midiSelect.value;if(this.midiSelect.innerHTML="",e.length===0){const a=document.createElement("option");a.value="",a.textContent="No Devices Found",this.midiSelect.appendChild(a),this.midiSelect.disabled=!0}else{this.midiSelect.disabled=!1;for(const a of e){const n=document.createElement("option");n.value=a.id,n.textContent=a.name,this.midiSelect.appendChild(n)}e.some(a=>a.id===t)?this.midiSelect.value=t:e.length>0&&(this.midiSelect.selectedIndex=0,this.onMidiInputChange&&this.onMidiInputChange(this.midiSelect.value))}}setVolumeResolutionChangeCallback(e){this.onVolumeResolutionChange=e}setSpectralDataChangeCallback(e){this.onSpectralDataChange=e}setWavUploadCallback(e){this.onWavUpload=e}setDynamicParamChangeCallback(e){this.onDynamicParamChange=e}setLFOParamChangeCallback(e){this.onLFOParamChange=e}setModulationRoutingChangeCallback(e){this.onModulationRoutingChange=e}showDynamicParam(e,t,a,n,i){if(!this.dynamicParamSlider||!this.dynamicParamContainer)return;const s=document.getElementById("dynamic-param-label"),o=document.getElementById("dynamic-param-value");s&&(s.textContent=e),this.dynamicParamSlider.min=String(t),this.dynamicParamSlider.max=String(a),this.dynamicParamSlider.value=String(n),this.dynamicParamSlider.step=String(i),o&&(o.textContent=i>=1?String(Math.round(n)):n.toFixed(2)),this.dynamicParamContainer.style.display="block"}hideDynamicParam(){this.dynamicParamContainer&&(this.dynamicParamContainer.style.display="none")}getState(){return{position:{x:0,y:parseFloat(this.pathYSlider.value),z:0},rotation:{x:0,y:0,z:0},scanPosition:parseFloat(this.scanPositionSlider.value),planeType:this.planeTypeSelect.value}}updateScanPosition(e){this.scanPositionSlider.value=String(e);const t=document.getElementById("scan-pos-value");t&&(t.textContent=e.toFixed(2)),this.onPathChange&&this.onPathChange(this.getState())}updatePathY(e){this.pathYSlider.value=String(e);const t=document.getElementById("path-y-value");t&&(t.textContent=e.toFixed(2)),this.onPathChange&&this.onPathChange(this.getState())}addSpectralDataOption(e,t){if(!Array.from(this.spectralDataSelect.options).find(i=>i.value===e)){const i=document.createElement("option");i.value=e,i.textContent=t,this.spectralDataSelect.appendChild(i)}this.spectralDataSelect.value=e;const n=new Event("change");this.spectralDataSelect.dispatchEvent(n)}setVolumeDensity(e){this.densityXSlider.value=String(e.x),this.densityYSlider.value=String(e.y),this.densityZSlider.value=String(e.z);const t=document.getElementById("density-x-value"),a=document.getElementById("density-y-value"),n=document.getElementById("density-z-value");t&&(t.textContent=String(Math.round(e.x))),a&&(a.textContent=String(Math.round(e.y))),n&&(n.textContent=String(Math.round(e.z)))}showProgress(){const e=document.getElementById("wav-progress-container");e&&(e.style.display="flex")}hideProgress(){const e=document.getElementById("wav-progress-container");e&&(e.style.display="none")}updateProgress(e){const t=document.getElementById("wav-progress-fill"),a=document.getElementById("wav-progress-text");t&&(t.style.width=`${e}%`),a&&(a.textContent=`${Math.round(e)}%`)}}class Le{constructor(e){r(this,"canvas");r(this,"ctx");r(this,"width");r(this,"height");r(this,"tempCanvas");r(this,"tempCtx");r(this,"mode","SCANLINE");this.canvas=document.getElementById(e);const t=this.canvas.getContext("2d");if(!t)throw new Error("Failed to get 2D context");this.ctx=t,this.tempCanvas=document.createElement("canvas");const a=this.tempCanvas.getContext("2d");if(!a)throw new Error("Failed to get temp 2D context");this.tempCtx=a,this.width=320,this.height=160,this.resize(),window.addEventListener("resize",()=>this.resize()),this.canvas.addEventListener("click",()=>{this.mode=this.mode==="SCANLINE"?"AUDIO_OUTPUT":"SCANLINE"})}resize(){const e=this.canvas.clientWidth,t=this.canvas.clientHeight,a=window.devicePixelRatio||1;this.canvas.width=e*a,this.canvas.height=t*a,this.width=e*a,this.height=t*a,this.tempCanvas.width=e*a,this.tempCanvas.height=t*a,this.ctx.fillStyle="#000",this.ctx.fillRect(0,0,this.width,this.height)}update(e,t){if(!e)return;this.tempCtx.drawImage(this.canvas,0,0),this.ctx.drawImage(this.tempCtx.canvas,0,-1);const a=this.height-1,n=this.width;let i,s=!1;this.mode==="AUDIO_OUTPUT"&&t?(i=t,s=!0):i=e;const o=s?i.length:i.length/4,l=this.ctx.createImageData(n,1),h=l.data;for(let c=0;c<n;c++){const d=c/n;let m;if(s){const C=Math.pow(d,2);m=Math.floor(C*(o-1))}else m=Math.floor(d*(o-1));let u;s?(u=(i[m]+100)/70,u=Math.max(0,Math.min(1,u))):u=i[m*4];let p=0,g=0,y=0;if(u<.5){const C=u*2;p=0,g=C*255,y=C*255}else p=(u-.5)*2*255,g=255,y=255;const v=c*4;h[v+0]=p,h[v+1]=g,h[v+2]=y,h[v+3]=255}this.ctx.putImageData(l,0,a)}}class Te{constructor(e){r(this,"canvas");r(this,"ctx");r(this,"width");r(this,"height");r(this,"mode","channels");this.canvas=document.getElementById(e),this.canvas.addEventListener("click",()=>{this.mode=this.mode==="lissajous"?"channels":"lissajous"});const t=this.canvas.getContext("2d");if(!t)throw new Error("Failed to get 2D context");this.ctx=t,this.width=320,this.height=160,this.resize(),window.addEventListener("resize",()=>this.resize())}resize(){const e=this.canvas.clientWidth,t=this.canvas.clientHeight,a=window.devicePixelRatio||1;this.canvas.width=e*a,this.canvas.height=t*a,this.width=e*a,this.height=t*a}draw(e,t){const a=this.width,n=this.height,i=a/2,s=n/2;if(this.ctx.fillStyle="rgba(0, 0, 0, 0.2)",this.ctx.fillRect(0,0,a,n),this.ctx.lineWidth=1.5,this.mode==="lissajous"){this.ctx.strokeStyle="#00ff88",this.ctx.beginPath();const o=Math.min(a,n)*.4,l=2;for(let h=0;h<e.length;h+=l){const c=e[h],d=t[h],m=c*o+i,u=-d*o+s;h===0?this.ctx.moveTo(m,u):this.ctx.lineTo(m,u)}this.ctx.stroke()}else{const o=n*.4,l=Math.ceil(e.length/a);this.ctx.strokeStyle="#888888",this.ctx.beginPath();for(let h=0;h<e.length;h+=l){const c=h/e.length*a,d=s-e[h]*o;h===0?this.ctx.moveTo(c,d):this.ctx.lineTo(c,d)}this.ctx.stroke(),this.ctx.strokeStyle="#ff4444",this.ctx.beginPath();for(let h=0;h<t.length;h+=l){const c=h/t.length*a,d=s-t[h]*o;h===0?this.ctx.moveTo(c,d):this.ctx.lineTo(c,d)}this.ctx.stroke()}}}const Re=`
class SpectralProcessor extends AudioWorkletProcessor {
    constructor() {
        super();
        this.spectralData = new Float32Array(1024 * 4); // RGBA
        this.phaseAccumulators = new Float32Array(1024); // For oscillator bank
        this.frequencyMultiplier = 1.0;
        this.port.onmessage = (e) => {
            if (e.data.type === 'spectral-data') {
                this.spectralData = e.data.data;
            } else if (e.data.type === 'frequency-multiplier') {
                this.frequencyMultiplier = e.data.value;
            }
        };
    }

    process(inputs, outputs, parameters) {
        const output = outputs[0];
        const channelL = output[0];
        const channelR = output[1];
        
        const numPoints = this.spectralData.length / 4;
        
        for (let i = 0; i < channelL.length; i++) {
            let sumL = 0;
            let sumR = 0;
            
            for (let bin = 0; bin < numPoints; bin++) {
                const idx = bin * 4;
                const mag = this.spectralData[idx];
                const phaseOffset = this.spectralData[idx + 1];
                const custom1 = this.spectralData[idx + 2];
                
                if (mag < 0.001) continue;

                const minFreq = 20;
                const maxFreq = 20000;
                const normalizedBin = bin / numPoints;
                const baseFreq = minFreq + (maxFreq - minFreq) * normalizedBin;
                const freq = baseFreq * this.frequencyMultiplier;
                
                const db = mag * 60 - 60;
                const linearMag = Math.pow(10, db / 20);
                
                const phaseInc = (freq * 2 * Math.PI) / sampleRate;
                this.phaseAccumulators[bin] += phaseInc;
                if (this.phaseAccumulators[bin] > 2 * Math.PI) {
                    this.phaseAccumulators[bin] -= 2 * Math.PI;
                }
                
                const currentPhase = this.phaseAccumulators[bin] + (phaseOffset * 2 * Math.PI);
                const sample = Math.sin(currentPhase);
                
                const p = (custom1 - 0.5) * 2;
                const gainL = Math.min(1, 1 - p) * linearMag;
                const gainR = Math.min(1, 1 + p) * linearMag;
                
                sumL += sample * gainL;
                sumR += sample * gainR;
            }
            
            const scale = 0.1; 
            channelL[i] = sumL * scale;
            channelR[i] = sumR * scale;
        }
        
        return true;
    }
}
registerProcessor('spectral-processor', SpectralProcessor);
`,Fe=`
class WavetableProcessor extends AudioWorkletProcessor {
    constructor() {
        super();
        this.envelope = new Float32Array(1024); // Amplitude envelope from reading line
        this.envelopeSize = 64;
        this.phase = 0;           // Carrier phase (0-1)
        this.envPhase = 0;        // Envelope read position (0-1)
        this.frequency = 220;     // Carrier frequency Hz
        this.carrierType = 0;     // 0=sine, 1=saw, 2=square, 3=triangle
        this.feedback = 0;        // Feedback amount 0-1
        this.lastSample = 0;      // Previous output for feedback
        
        this.port.onmessage = (e) => {
            if (e.data.type === 'spectral-data') {
                const data = e.data.data;
                const numPoints = data.length / 4;
                this.envelopeSize = numPoints;
                
                let maxMag = 0;
                for (let i = 0; i < numPoints; i++) {
                    const mag = data[i * 4];
                    if (mag > maxMag) maxMag = mag;
                }
                
                const scale = maxMag > 0.001 ? 1.0 / maxMag : 1.0;
                for (let i = 0; i < numPoints; i++) {
                    this.envelope[i] = data[i * 4] * scale;
                }
            } else if (e.data.type === 'frequency') {
                this.frequency = e.data.value;
            } else if (e.data.type === 'carrier') {
                this.carrierType = e.data.value;
            } else if (e.data.type === 'feedback') {
                this.feedback = e.data.value;
            }
        };
    }
    
    // Generate carrier waveform sample at phase (0-1)
    carrier(phase, type) {
        switch (type) {
            case 0: // Sine
                return Math.sin(phase * 2 * Math.PI);
            case 1: // Saw (falling)
                return 1 - 2 * phase;
            case 2: // Square
                return phase < 0.5 ? 1 : -1;
            case 3: // Triangle
                return phase < 0.5 
                    ? 4 * phase - 1 
                    : 3 - 4 * phase;
            default:
                return Math.sin(phase * 2 * Math.PI);
        }
    }

    process(inputs, outputs, parameters) {
        const output = outputs[0];
        const channelL = output[0];
        const channelR = output[1];
        
        if (this.envelopeSize < 2) {
            for (let i = 0; i < channelL.length; i++) {
                channelL[i] = 0;
                channelR[i] = 0;
            }
            return true;
        }
        
        const carrierPhaseInc = this.frequency / sampleRate;
        const envPhaseInc = carrierPhaseInc;
        
        for (let i = 0; i < channelL.length; i++) {
            // Get base carrier sample
            let carrierSample = this.carrier(this.phase, this.carrierType);
            
            // Mix in feedback: blend carrier with previous output
            // feedback=0: pure carrier, feedback=1: 50/50 mix with previous
            if (this.feedback > 0) {
                carrierSample = carrierSample * (1 - this.feedback * 0.5) + this.lastSample * this.feedback * 0.5;
            }
            
            // Get envelope with linear interpolation
            const envPos = this.envPhase * this.envelopeSize;
            const envIdx0 = Math.floor(envPos) % this.envelopeSize;
            const envIdx1 = (envIdx0 + 1) % this.envelopeSize;
            const envFrac = envPos - Math.floor(envPos);
            const amplitude = this.envelope[envIdx0] * (1 - envFrac) + this.envelope[envIdx1] * envFrac;
            
            // AM synthesis: carrier * envelope
            const sample = carrierSample * amplitude;
            
            // Store for feedback
            this.lastSample = sample;
            
            const gain = 0.5;
            channelL[i] = sample * gain;
            channelR[i] = sample * gain;
            
            // Advance phases
            this.phase += carrierPhaseInc;
            if (this.phase >= 1.0) this.phase -= 1.0;
            
            this.envPhase += envPhaseInc;
            if (this.envPhase >= 1.0) this.envPhase -= 1.0;
        }
        
        return true;
    }
}
registerProcessor('wavetable-processor', WavetableProcessor);
`;class Ne{constructor(){r(this,"ctx");r(this,"workletNode",null);r(this,"isInitialized",!1);r(this,"currentMode",I.WAVETABLE);r(this,"timeDomainDataL");r(this,"timeDomainDataR");r(this,"frequencyDataL");r(this,"frequencyDataR");r(this,"splitNode");r(this,"analyserL");r(this,"analyserR");r(this,"masterGain");r(this,"attack",.1);r(this,"decay",.2);r(this,"sustain",.5);r(this,"release",.5);r(this,"lastNoteTime",0);r(this,"isNoteOn",!1);r(this,"wavetableFrequency",220);r(this,"carrierType",0);r(this,"feedback",0);this.ctx=new(window.AudioContext||window.webkitAudioContext),this.splitNode=this.ctx.createChannelSplitter(2),this.analyserL=this.ctx.createAnalyser(),this.analyserR=this.ctx.createAnalyser(),this.masterGain=this.ctx.createGain(),this.masterGain.gain.value=0,this.analyserL.fftSize=2048,this.analyserR.fftSize=2048,this.timeDomainDataL=new Float32Array(this.analyserL.fftSize),this.timeDomainDataR=new Float32Array(this.analyserR.fftSize),this.frequencyDataL=new Float32Array(this.analyserL.frequencyBinCount),this.frequencyDataR=new Float32Array(this.analyserR.frequencyBinCount),this.splitNode.connect(this.analyserL,0),this.splitNode.connect(this.analyserR,1)}async initialize(){if(!this.isInitialized)try{const e=new Blob([Re],{type:"application/javascript"}),t=new Blob([Fe],{type:"application/javascript"}),a=URL.createObjectURL(e),n=URL.createObjectURL(t);await this.ctx.audioWorklet.addModule(a),await this.ctx.audioWorklet.addModule(n),URL.revokeObjectURL(a),URL.revokeObjectURL(n),this.createWorkletNode(),this.isInitialized=!0,console.log(`✓ Audio Engine initialized (mode: ${this.currentMode})`)}catch(e){console.error("Failed to initialize Audio Engine:",e)}}createWorkletNode(){this.workletNode&&(this.workletNode.disconnect(),this.workletNode=null);const e=this.currentMode===I.SPECTRAL?"spectral-processor":"wavetable-processor";this.workletNode=new AudioWorkletNode(this.ctx,e,{numberOfInputs:0,numberOfOutputs:1,outputChannelCount:[2]}),this.workletNode.connect(this.masterGain),this.masterGain.connect(this.ctx.destination),this.masterGain.connect(this.splitNode),this.currentMode===I.WAVETABLE&&this.workletNode.port.postMessage({type:"frequency",value:this.wavetableFrequency})}setMode(e){e!==this.currentMode&&(this.currentMode=e,this.isInitialized&&(this.createWorkletNode(),console.log(`✓ Synth mode changed to: ${e}`)))}getMode(){return this.currentMode}setWavetableFrequency(e){this.wavetableFrequency=e,this.workletNode&&this.currentMode===I.WAVETABLE&&this.workletNode.port.postMessage({type:"frequency",value:e})}getWavetableFrequency(){return this.wavetableFrequency}setCarrier(e){this.carrierType=e,this.workletNode&&this.currentMode===I.WAVETABLE&&this.workletNode.port.postMessage({type:"carrier",value:e})}getCarrier(){return this.carrierType}setFeedback(e){this.feedback=e,this.workletNode&&this.currentMode===I.WAVETABLE&&this.workletNode.port.postMessage({type:"feedback",value:e})}getFeedback(){return this.feedback}updateSpectralData(e){!this.workletNode||!this.isInitialized||this.workletNode.port.postMessage({type:"spectral-data",data:e})}getScopeData(){return this.analyserL.getFloatTimeDomainData(this.timeDomainDataL),this.analyserR.getFloatTimeDomainData(this.timeDomainDataR),{left:this.timeDomainDataL,right:this.timeDomainDataR}}getAudioSpectralData(){return this.analyserL.getFloatFrequencyData(this.frequencyDataL),this.analyserR.getFloatFrequencyData(this.frequencyDataR),{left:this.frequencyDataL,right:this.frequencyDataR}}setSpectralPitch(e){this.workletNode&&this.currentMode===I.SPECTRAL&&this.workletNode.port.postMessage({type:"frequency-multiplier",value:e})}resume(){this.ctx.state==="suspended"&&this.ctx.resume()}triggerAttack(e){const t=this.ctx.currentTime;this.lastNoteTime=t,this.isNoteOn=!0,e&&(this.attack=e.a,this.decay=e.d,this.sustain=e.s),this.masterGain.gain.cancelScheduledValues(t);const a=this.masterGain.gain.value;this.masterGain.gain.setValueAtTime(a,t),this.masterGain.gain.linearRampToValueAtTime(1,t+this.attack),this.masterGain.gain.linearRampToValueAtTime(this.sustain,t+this.attack+this.decay)}triggerRelease(e){const t=this.ctx.currentTime;this.isNoteOn=!1,e!==void 0&&(this.release=e),this.masterGain.gain.cancelScheduledValues(t);const a=this.masterGain.gain.value;this.masterGain.gain.setValueAtTime(a,t),this.masterGain.gain.linearRampToValueAtTime(0,t+this.release)}getEnvelopeState(){return{attack:this.attack,decay:this.decay,sustain:this.sustain,release:this.release,isNoteOn:this.isNoteOn,lastNoteTime:this.lastNoteTime,currentTime:this.ctx.currentTime}}}class De{constructor(){r(this,"audioContext");this.audioContext=new(window.AudioContext||window.webkitAudioContext)}async analyzeMultipleFiles(e,t,a){const{x:n,y:i,z:s}=t,o=e.length;console.log(`Analyzing ${o} files for morphing into ${n}x${i}x${s} volume`);const l=new Float32Array(n*i*s*4);for(let h=0;h<o;h++){const c=e[h],d=await c.arrayBuffer(),m=await this.audioContext.decodeAudioData(d),u=m.getChannelData(0),p=m.sampleRate;console.log(`  [${h+1}/${o}] ${c.name}: ${m.duration.toFixed(2)}s`);const g=o===1?0:-1+h/(o-1)*2,y=Math.round((g+1)*.5*(i-1)),v=2048,C=s*v,x=this.timeStretch(u,C),P=20,T=2e4;for(let S=0;S<s;S++){const L=S*v,b=new Float32Array(v);for(let w=0;w<v;w++)L+w<x.length&&(b[w]=x[L+w]);for(let w=0;w<v;w++)b[w]*=.5*(1-Math.cos(2*Math.PI*w/v));const R=this.simpleFFT(b);for(let w=0;w<n;w++){const A=w/n,M=P+(T-P)*A,N=Math.floor(M*v/p),z=Math.max(0,Math.min(R.length-1,N)),D=R[z]||0;let E=0;D>1e-6&&(E=(20*Math.log10(D)+60)/60,E=Math.max(0,Math.min(1,E)));const F=(S*i*n+y*n+w)*4;l[F]=E,l[F+1]=w/n,l[F+2]=w/n,l[F+3]=S/s}if(a&&S%10===0){const w=h/o*100,A=S/s/o*100;a(w+A)}S%20===0&&await new Promise(w=>requestAnimationFrame(w))}}return a&&a(100),console.log("✓ Multi-file morphing volume created"),l}async analyzeFile(e,t,a){const n=await e.arrayBuffer(),i=await this.audioContext.decodeAudioData(n),s=i.getChannelData(0),o=s.length,l=i.sampleRate;console.log(`Analyzing: ${e.name}, ${i.duration.toFixed(2)}s, ${l}Hz, ${o} samples`);const{x:h,y:c,z:d}=t,u=d*c*2048;let p;o<u?(console.log(`Time-stretching audio: ${o} → ${u} samples (${(u/o).toFixed(2)}x)`),a&&a(10),p=this.timeStretch(s,u),a&&a(20)):(p=s,a&&a(15));const g=new Float32Array(h*c*d*4),y=d;let v=0,C=performance.now();const x=Math.floor(p.length/d),P=20,T=2e4;for(let S=0;S<d;S++){const L=S*x,b=2048,R=new Float32Array(b);for(let M=0;M<b;M++)L+M<p.length&&(R[M]=p[L+M]);for(let M=0;M<b;M++)R[M]*=.5*(1-Math.cos(2*Math.PI*M/b));const w=this.simpleFFT(R),A=w.length;for(let M=0;M<h;M++){const N=M/h,z=P+(T-P)*N,D=Math.floor(z*b/l),E=Math.max(0,Math.min(A-1,D)),F=w[E]||0;let V=0;F>1e-6&&(V=(20*Math.log10(F)+60)/60,V=Math.max(0,Math.min(1,V)));for(let U=0;U<c;U++){const q=(S*c*h+U*h+M)*4;g[q]=V,g[q+1]=M/h,g[q+2]=M/h,g[q+3]=S/d}}if(v++,a&&v%5===0){const M=20+v/y*80;a(M)}performance.now()-C>12&&(await new Promise(M=>requestAnimationFrame(M)),C=performance.now())}return a&&a(100),console.log("✓ Converted to spectral volume"),{data:g,adjustedSize:t}}timeStretch(e,t){const a=new Float32Array(t),n=e.length/t;for(let i=0;i<t;i++){const s=i*n,o=Math.floor(s),l=s-o;o+1<e.length?a[i]=e[o]*(1-l)+e[o+1]*l:a[i]=e[o]}return a}simpleFFT(e){const t=e.length,a=new Float32Array(t/2);for(let n=0;n<t/2;n++){let i=0,s=0;for(let o=0;o<t;o++){const l=-2*Math.PI*n*o/t;i+=e[o]*Math.cos(l),s+=e[o]*Math.sin(l)}a[n]=Math.sqrt(i*i+s*s)/t}return a}}class Ve{constructor(){r(this,"midiAccess",null);r(this,"activeInput",null);r(this,"activeNotes",new Map);r(this,"onNoteChangeCallback",null);r(this,"onConnectionChangeCallback",null);r(this,"onRawNoteCallback",null);this.initialize()}async initialize(){try{if(navigator.requestMIDIAccess){this.midiAccess=await navigator.requestMIDIAccess();const e=this.midiAccess.inputs.values();for(let t of e){this.setInput(t);break}this.midiAccess.onstatechange=t=>{console.log("MIDI State Change:",t.port.name,t.port.state,t.port.connection),t.port.type==="input"&&(t.port.state==="connected"&&!this.activeInput?this.setInput(t.port):t.port.state==="disconnected"&&this.activeInput&&this.activeInput.id===t.port.id&&(this.activeInput=null,this.onConnectionChangeCallback&&this.onConnectionChangeCallback(!1)))}}else console.warn("Web MIDI API not supported in this browser.")}catch(e){console.error("MIDI Access Failed:",e)}}setInput(e){this.activeInput=e,console.log(`MIDI Input Selected: ${e.name}`),e.onmidimessage=t=>{this.handleMessage(t)},this.onConnectionChangeCallback&&this.onConnectionChangeCallback(!0)}handleMessage(e){const[t,a,n]=e.data,i=t&240,s=a,o=n;i===144&&o>0?(this.activeNotes.set(s,o),this.triggerHighestNote(),this.onRawNoteCallback&&this.onRawNoteCallback(s,o)):(i===128||i===144&&o===0)&&(this.activeNotes.delete(s),this.triggerHighestNote(),this.onRawNoteCallback&&this.onRawNoteCallback(s,0))}triggerHighestNote(){if(!this.onNoteChangeCallback)return;if(this.activeNotes.size===0){this.onNoteChangeCallback(null);return}let e=-1;for(let t of this.activeNotes.keys())t>e&&(e=t);e!==-1&&this.onNoteChangeCallback(e)}setNoteChangeCallback(e){this.onNoteChangeCallback=e}setRawNoteCallback(e){this.onRawNoteCallback=e}setConnectionChangeCallback(e){this.onConnectionChangeCallback=e}getInputs(){if(!this.midiAccess)return[];const e=[];return this.midiAccess.inputs.forEach(t=>{e.push({id:t.id,name:t.name})}),e}selectInput(e){if(!this.midiAccess)return;const t=this.midiAccess.inputs.get(e);t&&this.setInput(t)}simulateNoteOn(e,t){this.activeNotes.set(e,t),this.triggerHighestNote(),this.onRawNoteCallback&&this.onRawNoteCallback(e,t)}simulateNoteOff(e){this.activeNotes.delete(e),this.triggerHighestNote(),this.onRawNoteCallback&&this.onRawNoteCallback(e,0)}}class Ie{constructor(e,t){r(this,"canvas");r(this,"ctx");r(this,"engine");r(this,"width",0);r(this,"height",0);r(this,"maxTime",2);r(this,"padding",20);r(this,"isDragging",!1);r(this,"activeNode",-1);r(this,"sustainVisualDuration",.5);const a=document.getElementById(e);if(!a)throw new Error(`Canvas ${e} not found`);this.canvas=a,this.ctx=this.canvas.getContext("2d"),this.engine=t,this.resize(),window.addEventListener("resize",()=>this.resize()),this.canvas.addEventListener("mousedown",this.onMouseDown.bind(this)),window.addEventListener("mousemove",this.onMouseMove.bind(this)),window.addEventListener("mouseup",this.onMouseUp.bind(this)),this.animate()}resize(){this.canvas.width=this.canvas.clientWidth,this.canvas.height=this.canvas.clientHeight,this.width=this.canvas.width,this.height=this.canvas.height,this.draw()}animate(){this.draw(),requestAnimationFrame(()=>this.animate())}draw(){const{width:e,height:t,ctx:a}=this,n=this.engine.getEnvelopeState();a.fillStyle="#08080c",a.fillRect(0,0,e,t),a.strokeStyle="#222",a.lineWidth=1,a.beginPath();for(let p=0;p<=this.maxTime;p+=.5){const g=this.timeToX(p);a.moveTo(g,0),a.lineTo(g,t)}for(let p=0;p<=1;p+=.5){const g=this.valToY(p);a.moveTo(0,g),a.lineTo(e,g)}a.stroke();const i=n.attack,s=n.decay,o=n.sustain,l=n.release,h={x:0,y:0},c={x:i,y:1},d={x:i+s,y:o},m={x:i+s+this.sustainVisualDuration,y:o},u={x:i+s+this.sustainVisualDuration+l,y:0};if(a.strokeStyle="#00ff88",a.lineWidth=2,a.beginPath(),a.moveTo(this.timeToX(h.x),this.valToY(h.y)),a.lineTo(this.timeToX(c.x),this.valToY(c.y)),a.lineTo(this.timeToX(d.x),this.valToY(d.y)),a.lineTo(this.timeToX(m.x),this.valToY(m.y)),a.lineTo(this.timeToX(u.x),this.valToY(u.y)),a.stroke(),this.drawNode(c.x,c.y,this.activeNode===0),this.drawNode(d.x,d.y,this.activeNode===1),this.drawNode(u.x,u.y,this.activeNode===2),a.fillStyle="#666",a.font="10px Inter",a.fillText("A",this.timeToX(c.x),this.valToY(c.y)-10),a.fillText("D",this.timeToX(d.x),this.valToY(d.y)-10),a.fillText("R",this.timeToX(u.x),this.valToY(u.y)-10),n.isNoteOn){const p=n.currentTime-n.lastNoteTime;let g=0;if(p<i+s)g=p;else{const v=p-(i+s),C=i+s+this.sustainVisualDuration;g=Math.min(i+s+v,C)}const y=this.timeToX(g);a.strokeStyle="#0088ff",a.lineWidth=2,a.beginPath(),a.moveTo(y,0),a.lineTo(y,t),a.stroke()}}drawNode(e,t,a){const n=this.timeToX(e),i=this.valToY(t);this.ctx.beginPath(),this.ctx.arc(n,i,6,0,Math.PI*2),this.ctx.fillStyle=a?"#fff":"#00ff88",this.ctx.fill(),this.ctx.stroke()}timeToX(e){return this.padding+e/this.maxTime*(this.width-2*this.padding)}xToTime(e){return(e-this.padding)/(this.width-2*this.padding)*this.maxTime}valToY(e){const t=this.height-2*this.padding;return this.height-this.padding-e*t}yToVal(e){const t=this.height-2*this.padding;return(this.height-this.padding-e)/t}onMouseDown(e){const t=this.canvas.getBoundingClientRect(),a=e.clientX-t.left,n=e.clientY-t.top,i=this.engine.getEnvelopeState(),s={t:i.attack,v:1},o={t:i.attack+i.decay,v:i.sustain},l={t:i.attack+i.decay+this.sustainVisualDuration+i.release,v:0},h=[s,o,l];for(let c=0;c<h.length;c++){const d=this.timeToX(h[c].t),m=this.valToY(h[c].v);if(Math.sqrt((a-d)**2+(n-m)**2)<10){this.isDragging=!0,this.activeNode=c;return}}}onMouseMove(e){if(!this.isDragging)return;const t=this.canvas.getBoundingClientRect(),a=e.clientX-t.left,n=e.clientY-t.top,i=Math.max(0,this.xToTime(a)),s=Math.max(0,Math.min(1,this.yToVal(n))),o=this.engine.getEnvelopeState();if(this.activeNode===0)this.engine.attack=i;else if(this.activeNode===1){this.engine.sustain=s;const l=i-o.attack;this.engine.decay=Math.max(0,l)}else if(this.activeNode===2){const l=o.attack+o.decay+this.sustainVisualDuration,h=i-l;this.engine.release=Math.max(.01,h)}}onMouseUp(){this.isDragging=!1,this.activeNode=-1}}class ze{constructor(e){r(this,"container");r(this,"keys",new Map);r(this,"activeNotes",new Set);r(this,"onNoteChange",null);r(this,"numOctaves",3);r(this,"baseOctave",3);r(this,"startNote",36);r(this,"endNote",72);const t=document.getElementById(e);if(!t)throw new Error(`Container ${e} not found`);this.container=t,this.updateRange(),this.container.addEventListener("selectstart",a=>a.preventDefault())}setBaseOctave(e){this.baseOctave=e,this.updateRange()}updateRange(){this.startNote=this.baseOctave*12,this.endNote=this.startNote+this.numOctaves*12,this.createKeys()}createKeys(){this.container.innerHTML="",this.keys.clear();const e=[0,2,4,5,7,9,11];let t=0;for(let i=this.startNote;i<=this.endNote;i++)e.includes(i%12)&&t++;const a=100/t;let n=0;for(let i=this.startNote;i<=this.endNote;i++){const s=i%12,o=e.includes(s),l=document.createElement("div");this.keys.set(i,l),l.dataset.note=String(i),o?(l.className="piano-key white",l.style.width=`${a}%`,l.style.left=`${n*a}%`,n++):(l.className="piano-key black",l.style.width=`${a*.7}%`,l.style.left=`${(n-1)*a+a*.65}%`,l.style.zIndex="2"),l.addEventListener("mousedown",h=>{if(h.buttons===1){this.triggerNoteOn(i);const c=()=>{this.triggerNoteOff(i),window.removeEventListener("mouseup",c)};window.addEventListener("mouseup",c)}}),l.addEventListener("mouseenter",h=>{h.buttons===1&&(this.triggerNoteOn(i),l.addEventListener("mouseleave",()=>{this.triggerNoteOff(i)},{once:!0}))}),this.container.appendChild(l)}}triggerNoteOn(e){this.activeNotes.has(e)||(this.activeNotes.add(e),this.setVisualizeState(e,!0),this.onNoteChange&&this.onNoteChange(e,127))}triggerNoteOff(e){this.activeNotes.has(e)&&(this.activeNotes.delete(e),this.setVisualizeState(e,!1),this.onNoteChange&&this.onNoteChange(e,0))}setVisualizeState(e,t){const a=this.keys.get(e);a&&(t?a.classList.add("active"):a.classList.remove("active"))}setNoteChangeCallback(e){this.onNoteChange=e}}class ${constructor(e=1){r(this,"waveform","sine");r(this,"frequency",.5);r(this,"amplitude",1);r(this,"phase",0);this.frequency=e}setWaveform(e){this.waveform=e}setFrequency(e){this.frequency=e}setAmplitude(e){this.amplitude=e}update(e){this.phase+=this.frequency*e,this.phase>=1&&(this.phase-=Math.floor(this.phase));let t=0;switch(this.waveform){case"sine":t=Math.sin(this.phase*2*Math.PI);break;case"square":t=this.phase<.5?1:-1;break;case"saw":t=1-2*this.phase;break;case"triangle":t=this.phase<.5?4*this.phase-1:3-4*this.phase;break}return t*this.amplitude}}class ke{constructor(){r(this,"glContext");r(this,"renderer");r(this,"controls");r(this,"spectrogram");r(this,"scope");r(this,"audioEngine");r(this,"audioAnalyzer");r(this,"midiHandler");r(this,"piano");r(this,"canvas");r(this,"currentNote",null);r(this,"animationFrameId",0);r(this,"uploadedVolumes",new Map);r(this,"gameOfLifeActive",!1);r(this,"gameOfLifeSpeed",.5);r(this,"gameOfLifeLastUpdate",0);r(this,"sinePlasmaActive",!1);r(this,"sinePlasmaSpeed",.5);r(this,"sinePlasmaLastUpdate",0);r(this,"lfo1");r(this,"lfo2");r(this,"pathYSource","none");r(this,"scanPhaseSource","none");if(console.log("Spectra Table Synthesis - Initializing..."),this.canvas=document.getElementById("gl-canvas"),!this.canvas)throw new Error("Canvas not found");this.glContext=new ce(this.canvas);const e={x:H,y:j,z:Z};this.renderer=new Pe(this.glContext,e),this.controls=new Ae("controls"),this.spectrogram=new Le("spectrogram-canvas"),this.scope=new Te("scope-canvas"),this.audioEngine=new Ne,this.lfo1=new $,this.lfo2=new $,new Ie("envelope-canvas",this.audioEngine),this.audioAnalyzer=new De,this.midiHandler=new Ve,this.midiHandler.setNoteChangeCallback(this.onMidiNote.bind(this)),this.midiHandler.setConnectionChangeCallback(t=>{t&&console.log("✓ MIDI Device Connected"),this.controls.updateMidiInputs(this.midiHandler.getInputs())}),this.piano=new ze("piano-container"),this.piano.setNoteChangeCallback((t,a)=>{a>0?this.midiHandler.simulateNoteOn(t,a):this.midiHandler.simulateNoteOff(t)}),this.midiHandler.setRawNoteCallback((t,a)=>{this.piano.setVisualizeState(t,a>0)}),this.controls.setMidiInputChangeCallback(t=>{this.midiHandler.selectInput(t)}),this.controls.setOctaveChangeCallback(t=>{this.piano.setBaseOctave(t)}),setTimeout(()=>{this.controls.updateMidiInputs(this.midiHandler.getInputs())},500),this.controls.setPathChangeCallback(this.onPathChange.bind(this)),this.controls.setVolumeResolutionChangeCallback(this.onVolumeResolutionChange.bind(this)),this.controls.setSpectralDataChangeCallback(this.onSpectralDataChange.bind(this)),this.controls.setWavUploadCallback(this.onWavUpload.bind(this)),this.controls.setDynamicParamChangeCallback(this.onDynamicParamChange.bind(this)),this.controls.setSynthModeChangeCallback(this.onSynthModeChange.bind(this)),this.controls.setFrequencyChangeCallback(this.onFrequencyChange.bind(this)),this.controls.setCarrierChangeCallback(this.onCarrierChange.bind(this)),this.controls.setFeedbackChangeCallback(this.onFeedbackChange.bind(this)),this.controls.setLFOParamChangeCallback((t,a,n)=>{const i=t===0?this.lfo1:this.lfo2;a==="waveform"&&i.setWaveform(n),a==="frequency"&&i.setFrequency(n),a==="amplitude"&&i.setAmplitude(n)}),this.controls.setModulationRoutingChangeCallback((t,a)=>{t==="pathY"&&(this.pathYSource=a),t==="scanPhase"&&(this.scanPhaseSource=a)}),window.addEventListener("resize",this.onResize.bind(this)),this.onResize(),this.audioEngine.initialize().then(()=>{console.log("✓ Audio engine ready (suspended until user interaction)")}),this.canvas.addEventListener("mousedown",this.onMouseDown.bind(this)),this.canvas.addEventListener("mousemove",this.onMouseMove.bind(this)),this.canvas.addEventListener("mouseup",this.onMouseUp.bind(this)),this.canvas.addEventListener("mouseleave",this.onMouseUp.bind(this)),this.canvas.addEventListener("contextmenu",t=>(t.preventDefault(),!1)),this.canvas.addEventListener("click",()=>{this.audioEngine.resume()}),window.addEventListener("keydown",t=>{t.code==="Space"&&(t.preventDefault(),this.audioEngine.resume(),console.log("Audio resumed (Space)"))}),this.startRenderLoop(),console.log("✓ Application initialized")}onPathChange(e){this.renderer.updateReadingPath(e)}onVolumeResolutionChange(e){console.log("Volume resolution changed:",e),this.renderer.updateVolumeResolution(e);const t=document.getElementById("spectral-data-type")?.value||"blank";t==="game-of-life"&&this.gameOfLifeActive?(this.renderer.getSpectralVolume().initGameOfLife(),this.gameOfLifeLastUpdate=performance.now(),console.log("✓ Game of Life reinitialized with new density")):t==="sine-plasma"&&this.sinePlasmaActive?(this.renderer.getSpectralVolume().generateSinePlasma(0),this.sinePlasmaLastUpdate=performance.now(),console.log("✓ Sine Plasma reinitialized with new density")):this.uploadedVolumes.has(t)||this.renderer.updateSpectralData(t)}onSpectralDataChange(e){if(console.log("Spectral data changed:",e),this.gameOfLifeActive=!1,this.sinePlasmaActive=!1,this.uploadedVolumes.has(e)){const t=this.uploadedVolumes.get(e);this.renderer.getSpectralVolume().setData(t),this.controls.hideDynamicParam()}else e==="game-of-life"?(this.renderer.getSpectralVolume().initGameOfLife(),this.gameOfLifeActive=!0,this.gameOfLifeLastUpdate=performance.now(),this.controls.showDynamicParam("Evolution Speed",0,1,.5,.01),console.log("✓ Game of Life initialized")):e==="sine-plasma"?(this.renderer.getSpectralVolume().generateSinePlasma(0),this.sinePlasmaActive=!0,this.sinePlasmaLastUpdate=performance.now(),this.controls.showDynamicParam("Evolution Speed",0,1,.5,.01),console.log("✓ Sine Plasma initialized with evolution")):(this.renderer.updateSpectralData(e),this.controls.hideDynamicParam());this.audioEngine.resume()}onDynamicParamChange(e){this.gameOfLifeActive?(this.gameOfLifeSpeed=e,console.log(`Game of Life speed: ${e.toFixed(2)} (0=pause, 1=instant)`)):this.sinePlasmaActive&&(this.sinePlasmaSpeed=e,console.log(`Sine plasma speed: ${e.toFixed(2)} (0=static, 1=fast)`))}onSynthModeChange(e){this.audioEngine.setMode(e),console.log(`✓ Synth mode: ${e}`)}onFrequencyChange(e){this.audioEngine.setWavetableFrequency(e)}onCarrierChange(e){this.audioEngine.setCarrier(e)}onFeedbackChange(e){this.audioEngine.setFeedback(e)}onMidiNote(e){if(e===null){this.currentNote=null,this.audioEngine.triggerRelease();return}if(e===this.currentNote)return;this.currentNote=e;const t=440*Math.pow(2,(e-69)/12),a=this.audioEngine.getMode();if(a===I.WAVETABLE)this.audioEngine.setWavetableFrequency(t),this.controls&&this.controls.setFrequency(t);else if(a===I.SPECTRAL){const i=t/440;this.audioEngine.setSpectralPitch(i)}this.audioEngine.triggerAttack()}async onWavUpload(e){const t=Array.from(e);console.log(`Processing ${t.length} audio file(s) for morphing`);try{this.controls.showProgress(),this.controls.updateProgress(0);const a=this.renderer.getSpectralVolume().getResolution(),n=t.length,i={...a,y:n};this.controls.setVolumeDensity(i),this.renderer.updateVolumeResolution(i);const s=await this.audioAnalyzer.analyzeMultipleFiles(t,i,l=>this.controls.updateProgress(l)),o=t.length===1?t[0].name.replace(/\.[^/.]+$/,""):`Morph_${t.length}_samples`;this.uploadedVolumes.set(o,s),this.renderer.getSpectralVolume().setData(s),this.controls.addSpectralDataOption(o,o),console.log(`✓ Processed ${t.length} file(s) into morphing volume`)}catch(a){console.error("Failed to process audio file(s):",a),alert(`Error processing audio file(s): ${a instanceof Error?a.message:"Unknown error"}`)}finally{setTimeout(()=>this.controls.hideProgress(),500)}}onResize(){const e=this.canvas.getBoundingClientRect();this.renderer.resize(e.width,e.height)}onMouseDown(e){this.renderer.onMouseDown(e.clientX,e.clientY,e.button),this.audioEngine.resume()}onMouseMove(e){this.renderer.onMouseMove(e.clientX,e.clientY)}onMouseUp(){this.renderer.onMouseUp()}startRenderLoop(){let e=performance.now();const t=a=>{const n=(a-e)/1e3;if(e=a,this.gameOfLifeActive&&this.gameOfLifeSpeed>0){const c=(1-this.gameOfLifeSpeed)*1e3;a-this.gameOfLifeLastUpdate>=c&&(this.renderer.getSpectralVolume().stepGameOfLife(),this.gameOfLifeLastUpdate=a)}if(this.sinePlasmaActive&&this.sinePlasmaSpeed>0){const c=(1-this.sinePlasmaSpeed)*100;a-this.sinePlasmaLastUpdate>=c&&(this.renderer.getSpectralVolume().stepSinePlasma(),this.sinePlasmaLastUpdate=a)}const i=this.lfo1.update(n),s=this.lfo2.update(n);if(this.pathYSource!=="none"){const c=this.pathYSource==="lfo1"?i:s;this.controls.updatePathY(c)}if(this.scanPhaseSource!=="none"){const c=this.scanPhaseSource==="lfo1"?i:s;this.controls.updateScanPosition(c)}this.renderer.render(n);const o=this.renderer.getReadingLineSpectralData();this.audioEngine.updateSpectralData(o);const l=this.audioEngine.getAudioSpectralData();this.spectrogram.update(o,l.left);const h=this.audioEngine.getScopeData();this.scope.draw(h.left,h.right),this.animationFrameId=requestAnimationFrame(t)};requestAnimationFrame(t)}destroy(){this.animationFrameId&&cancelAnimationFrame(this.animationFrameId),this.renderer.destroy()}}const Oe=new ke;window.addEventListener("beforeunload",()=>{Oe.destroy()});
//# sourceMappingURL=index-GmN-bx8R.js.map
